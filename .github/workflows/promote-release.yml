# =============================================================================
# Promote Release - Prepare Release Branch for Production
# =============================================================================
#
# Purpose: When QA approves an RC, this workflow prepares the release branch
# for production by removing the -rc suffix from version numbers.
#
# IMPORTANT: This workflow does NOT merge the PR (org rules prevent bot merges).
# Instead, it updates the release branch so when a human merges, the version
# is clean (e.g., 6.17.8 instead of 6.17.8-rc1).
#
# Flow:
# 1. QA tests the RC version
# 2. QA adds label "pass QA ready for deploy" to the PR
# 3. This workflow triggers and:
#    - Updates the release branch to remove -rcN suffix
#    - Updates all version files
#    - Commits changes to the release branch
# 4. Human reviews and manually merges the PR
# 5. production-release.yml triggers on merge
#
# =============================================================================

name: Promote Release - Prepare for Production

on:
  pull_request:
    types: [labeled]
    branches:
      - master

concurrency:
  group: promote-release-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Job 1: Prepare Release Branch for Production
  # ===========================================================================
  prepare-for-production:
    name: üöÄ Prepare Release for Production
    # Only run when the specific label is added AND it's from a releases/ branch
    if: |
      github.event.label.name == 'pass QA ready for deploy' &&
      startsWith(github.event.pull_request.head.ref, 'releases/')
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.compute-version.outputs.version }}
      release_branch: ${{ steps.compute-version.outputs.release_branch }}
    
    steps:
      - name: üì• Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîç Compute production version
        id: compute-version
        run: |
          RELEASE_BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "Release branch: $RELEASE_BRANCH"
          
          # Get current version from pubspec.yaml
          CURRENT_VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "Current version: $CURRENT_VERSION"
          
          # Remove -rcN suffix to get production version
          PROD_VERSION=$(echo "$CURRENT_VERSION" | sed 's/-rc[0-9]*$//')
          echo "Production version: $PROD_VERSION"
          
          # Validate it's different (was an RC version)
          if [[ "$CURRENT_VERSION" == "$PROD_VERSION" ]]; then
            echo "‚ö†Ô∏è Version doesn't have -rc suffix. Already production ready?"
            echo "Current: $CURRENT_VERSION"
          fi
          
          echo "version=$PROD_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "release_branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT
      
      - name: üìù Update pubspec.yaml to production version
        run: |
          VERSION='${{ steps.compute-version.outputs.version }}'
          echo "Updating pubspec.yaml to production version: $VERSION"
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
          grep "^version:" pubspec.yaml
      
      - name: üìù Update plugin version constants (Android)
        run: |
          VERSION='${{ steps.compute-version.outputs.version }}'
          FILE="android/src/main/java/com/appsflyer/appsflyersdk/AppsFlyerConstants.java"
          if [ -f "$FILE" ]; then
            sed -i "s/kPluginVersion = \".*\"/kPluginVersion = \"$VERSION\"/" "$FILE"
            echo "Updated Android constants:"
            grep "kPluginVersion" "$FILE"
          fi
      
      - name: üìù Update plugin version constants (iOS)
        run: |
          VERSION='${{ steps.compute-version.outputs.version }}'
          FILE="ios/Classes/AppsflyerSdkPlugin.m"
          if [ -f "$FILE" ]; then
            sed -i "s/kPluginVersion = @\".*\"/kPluginVersion = @\"$VERSION\"/" "$FILE"
            echo "Updated iOS constants:"
            grep "kPluginVersion" "$FILE"
          fi
      
      - name: üíæ Commit and push version changes
        run: |
          VERSION='${{ steps.compute-version.outputs.version }}'
          CURRENT='${{ steps.compute-version.outputs.current_version }}'
          
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          if [[ -n $(git status -s) ]]; then
            git add pubspec.yaml android/ ios/
            git commit -m "chore: prepare production release $VERSION (from $CURRENT)"
            git push
            echo "‚úÖ Pushed version update to release branch"
          else
            echo "‚ÑπÔ∏è No version changes needed"
          fi
      
      - name: üìù Update PR description
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.compute-version.outputs.version }}';
            const currentVersion = '${{ steps.compute-version.outputs.current_version }}';
            const pr = context.payload.pull_request;
            
            const newBody = `### Production Release ${version}

            **Status:** ‚úÖ Ready for manual merge

            **Version updated:** ${currentVersion} ‚Üí ${version}

            ---

            ${pr.body || ''}

            ---

            **Next steps:**
            1. ‚úÖ QA approved (label added)
            2. ‚úÖ Version updated to production (${version})
            3. ‚è≥ **Awaiting manual merge** by a maintainer
            4. ‚è≥ Production release will trigger automatically after merge
            `;
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: newBody
            });
      
      - name: üì¢ Add comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.compute-version.outputs.version }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## üöÄ Ready for Production Release

            The release branch has been updated:
            - **Version:** \`${version}\` (removed -rc suffix)
            - **All version files updated**

            ### Next Steps
            1. **Review the changes** in this PR
            2. **Merge this PR** when ready
            3. The production release workflow will automatically:
               - Publish \`${version}\` to pub.dev
               - Create GitHub release
               - Send notifications

            > ‚ö†Ô∏è **Note:** This PR requires manual merge due to branch protection rules.`
            });

  # ===========================================================================
  # Job 2: Notify Team
  # ===========================================================================
  notify-ready:
    name: üì¢ Notify Ready for Merge
    needs: prepare-for-production
    runs-on: ubuntu-latest
    if: always() && needs.prepare-for-production.result == 'success'
    
    steps:
      - name: üì® Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "<!here>\n:white_check_mark: *Flutter Plugin Ready for Production*\n\nVersion: ${{ needs.prepare-for-production.outputs.version }}\nPR: ${{ github.event.pull_request.html_url }}\n\n*Action Required:* A maintainer needs to manually merge the PR to trigger the production release."
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.CI_SLACK_WEBHOOK_URL }}
        continue-on-error: true  # Will gracefully fail if webhook not configured
