# =============================================================================
# RC (Release Candidate) Workflow - Pre-Production Release
# =============================================================================
# 
# Purpose: Creates a release candidate for QA testing before production release.
# This workflow is triggered when a release branch is created or manually.
#
# What it does:
# 1. Validates the release branch naming convention
# 2. Runs full CI pipeline (tests + builds)
# 3. Updates version numbers in relevant files
# 4. Creates a pre-release tag on GitHub
# 5. Optionally notifies team via Slack (placeholder for future)
#
# Branch Convention: releases/X.x.x/X.Y.x/X.Y.Z[-rcN][+build]
# Examples: 
#   - releases/6.x.x/6.18.x/6.18.0-rc1
#   - releases/6.x.x/6.17.x/6.17.4+1-rc1
#   - releases/6.x.x/6.17.x/6.17.4+1
# Where: X, Y, Z are version numbers, lowercase 'x' is literal,
#        -rcN is optional for release candidates, +build is optional build number
#
# Triggers:
# - Push to branches matching releases/** pattern
# - Manual workflow dispatch with version input
#
# =============================================================================

name: RC - Release Candidate

on:
  # Manual-only triggering with required parameters
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch to create the release branch from (e.g., development)'
        required: false
        default: development
        type: string
      flutter_version:
        description: 'Flutter plugin version for this RC (e.g., 6.18.0-rc1 or 6.18.0+1-rc1)'
        required: true
        type: string
      ios_sdk_version:
        description: 'iOS native AppsFlyer SDK version (e.g., 6.17.7)'
        required: true
        type: string
      android_sdk_version:
        description: 'Android native AppsFlyer SDK version (e.g., 6.17.4)'
        required: true
        type: string
      deploy_to_qa:
        description: 'Open PR to master and publish RC to pub.dev'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip reusable CI when running this workflow (PR and production flows still run CI)'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Do not publish RC to pub.dev (still opens PR and creates prerelease)'
        required: false
        type: boolean
        default: true

# Prevent multiple RC workflows from running simultaneously
concurrency:
  group: rc-release-${{ github.run_id }}-${{ github.event.inputs.flutter_version || github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Job 1: Validate Release Branch
  # ===========================================================================
  # Ensures the branch follows naming conventions and extracts version info
  # ===========================================================================
  
  validate-release:
    name: üîç Validate Inputs & Compute Branch
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.compute.outputs.version }}
      base_version: ${{ steps.compute.outputs.base_version }}
      podspec_version: ${{ steps.compute.outputs.podspec_version }}
      is_rc: ${{ steps.compute.outputs.is_rc }}
      is_valid: ${{ steps.compute.outputs.is_valid }}
      base_branch: ${{ steps.compute.outputs.base_branch }}
      release_branch: ${{ steps.compute.outputs.release_branch }}
      ios_sdk_version: ${{ steps.compute.outputs.ios_sdk_version }}
      android_sdk_version: ${{ steps.compute.outputs.android_sdk_version }}
      deploy_to_qa: ${{ steps.compute.outputs.deploy_to_qa }}
      dry_run: ${{ steps.compute.outputs.dry_run }}
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üîç Validate and compute
        id: compute
        run: |
          set -euo pipefail
          VERSION="${{ github.event.inputs.flutter_version }}"
          IOS_VER="${{ github.event.inputs.ios_sdk_version }}"
          AND_VER="${{ github.event.inputs.android_sdk_version }}"
          BASE_BRANCH_INPUT="${{ github.event.inputs.base_branch }}"
          DEPLOY_TO_QA="${{ github.event.inputs.deploy_to_qa }}"
          DRY_RUN_INPUT="${{ github.event.inputs.dry_run }}"

          if [[ -z "$VERSION" || -z "$IOS_VER" || -z "$AND_VER" ]]; then
            echo "‚ùå Missing required inputs"; exit 1
          fi

          # Validate formats
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(\+[0-9]+)?-rc[0-9]+$ ]]; then
            echo "‚ùå flutter_version must be a prerelease like X.Y.Z[-build]+?-rcN (e.g., 6.18.0-rc1 or 6.18.0+1-rc1)"; exit 1
          fi
          if [[ ! $IOS_VER =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå ios_sdk_version must be X.Y.Z"; exit 1
          fi
          if [[ ! $AND_VER =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå android_sdk_version must be X.Y.Z"; exit 1
          fi

          # Compute base version (remove -rcN), keep +build if present
          BASE_VERSION=$(echo "$VERSION" | sed 's/-rc[0-9]*$//')
          # Podspec version must remove both +build and -rcN
          PODSPEC_VERSION=$(echo "$VERSION" | sed -E 's/(\+[0-9]+)?(-rc[0-9]+)?$//')

          MAJOR_MINOR=$(echo "$BASE_VERSION" | grep -oE '^[0-9]+\.[0-9]+')
          MAJOR=$(echo "$BASE_VERSION" | grep -oE '^[0-9]+')
          RELEASE_BRANCH="releases/${MAJOR}.x.x/${MAJOR_MINOR}.x/${VERSION}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "podspec_version=$PODSPEC_VERSION" >> $GITHUB_OUTPUT
          echo "is_rc=true" >> $GITHUB_OUTPUT
          echo "is_valid=true" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH_INPUT" >> $GITHUB_OUTPUT
          echo "release_branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT
          echo "ios_sdk_version=$IOS_VER" >> $GITHUB_OUTPUT
          echo "android_sdk_version=$AND_VER" >> $GITHUB_OUTPUT
          echo "deploy_to_qa=$DEPLOY_TO_QA" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN_INPUT" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Job 2: Run CI Pipeline
  # ===========================================================================
  # Reuses the main CI workflow to run tests and builds
  # ===========================================================================
  
  run-ci:
    name: üöÄ Run CI Pipeline
    needs: validate-release
    if: ${{ needs.validate-release.outputs.is_valid == 'true' && github.event.inputs.skip_tests != 'true' }}
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # ===========================================================================
  # Job 3: Create/Update Release Branch and Apply Changes
  # ===========================================================================
  
  prepare-branch:
    name: üåø Create Release Branch & Apply Changes
    runs-on: ubuntu-latest
    needs: [validate-release, run-ci]
    if: always() && needs.validate-release.outputs.is_valid == 'true'
    outputs:
      release_branch: ${{ steps.push.outputs.release_branch }}
    steps:
      - name: üì• Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-release.outputs.base_branch }}
          fetch-depth: 0

      - name: üîß Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: üåø Create release branch
        id: branch
        run: |
          set -e
          REL_BRANCH="${{ needs.validate-release.outputs.release_branch }}"
          echo "Target release branch: $REL_BRANCH"
          if git ls-remote --exit-code --heads origin "$REL_BRANCH" >/dev/null 2>&1; then
            echo "Branch already exists on remote. Checking it out."
            git fetch origin "$REL_BRANCH":"$REL_BRANCH"
            git checkout "$REL_BRANCH"
          else
            git checkout -b "$REL_BRANCH"
          fi

      - name: üìù Update pubspec.yaml version (RC full)
        run: |
          VERSION='${{ needs.validate-release.outputs.version }}'
          echo "Setting pubspec.yaml version to $VERSION (includes -rcN)"
          sed -i.bak "s/^version: .*/version: $VERSION/" pubspec.yaml
          rm pubspec.yaml.bak
          grep "^version:" pubspec.yaml

      - name: üìù Update Android SDK dependency
        run: |
          AND_VER='${{ needs.validate-release.outputs.android_sdk_version }}'
          sed -i.bak "s/com.appsflyer:af-android-sdk:[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*/com.appsflyer:af-android-sdk:${AND_VER}/" android/build.gradle
          rm android/build.gradle.bak
          grep "af-android-sdk:" -n android/build.gradle | head -1

      - name: üìù Update iOS podspec version and dependencies
        run: |
          PODSPEC_VERSION='${{ needs.validate-release.outputs.podspec_version }}'
          IOS_VER='${{ needs.validate-release.outputs.ios_sdk_version }}'
          FILE='ios/appsflyer_sdk.podspec'
          if [ -f "$FILE" ]; then
            sed -i.bak "s/s\.version\s*=\s*'.*'/s.version          = '${PODSPEC_VERSION}'/" "$FILE"
            sed -i.bak "s/ss\.ios\.dependency 'AppsFlyerFramework','[^']*'/ss.ios.dependency 'AppsFlyerFramework','${IOS_VER}'/" "$FILE"
            # PurchaseConnector line may or may not exist
            if grep -q "PurchaseConnector', '" "$FILE"; then
              sed -i.bak "s/ss\.ios\.dependency 'PurchaseConnector', '[^']*'/ss.ios.dependency 'PurchaseConnector', '${IOS_VER}'/" "$FILE" || true
            fi
            rm ${FILE}.bak || true
            echo "Updated podspec lines:"
            grep -n "s.version\|AppsFlyerFramework\|PurchaseConnector" "$FILE" || true
          else
            echo "‚ö†Ô∏è $FILE not found"
          fi

      - name: üìù Update plugin version constants (Android/iOS)
        run: |
          VERSION='${{ needs.validate-release.outputs.version }}'
          AND_FILE="android/src/main/java/com/appsflyer/appsflyersdk/AppsflyerConstants.java"
          IOS_FILE="ios/Classes/AppsflyerSdkPlugin.m"
          if [ -f "$AND_FILE" ]; then
            sed -i.bak "s/kPluginVersion = \".*\"/kPluginVersion = \"$VERSION\"/" "$AND_FILE" && rm "$AND_FILE.bak" || true
          fi
          if [ -f "$IOS_FILE" ]; then
            sed -i.bak "s/kPluginVersion = @\".*\"/kPluginVersion = @\"$VERSION\"/" "$IOS_FILE" && rm "$IOS_FILE.bak" || true
          fi

      - name: üìù Update README SDK versions
        run: |
          IOS_VER='${{ needs.validate-release.outputs.ios_sdk_version }}'
          AND_VER='${{ needs.validate-release.outputs.android_sdk_version }}'
          sed -i.bak -E "s/- Android AppsFlyer SDK \*\*v[0-9.]+\*\*/- Android AppsFlyer SDK **v${AND_VER}**/" README.md
          sed -i.bak -E "s/- iOS AppsFlyer SDK \*\*v[0-9.]+\*\*/- iOS AppsFlyer SDK **v${IOS_VER}**/" README.md
          rm README.md.bak
          echo "README updated SDK versions:"
          sed -n '12,20p' README.md | cat

      - name: üíæ Commit & push changes
        id: push
        run: |
          set -e
          REL_BRANCH='${{ needs.validate-release.outputs.release_branch }}'
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          if [[ -n $(git status -s) ]]; then
            git add pubspec.yaml android/ ios/ README.md || true
            git commit -m "chore: prepare RC ${VERSION} (iOS ${{ needs.validate-release.outputs.ios_sdk_version }}, Android ${{ needs.validate-release.outputs.android_sdk_version }})"
            git push --set-upstream origin "$REL_BRANCH"
          else
            echo "No changes to commit"
            # Ensure branch exists on remote
            if ! git ls-remote --exit-code --heads origin "$REL_BRANCH" >/dev/null 2>&1; then
              git push --set-upstream origin "$REL_BRANCH"
            fi
          fi
          echo "release_branch=$REL_BRANCH" >> $GITHUB_OUTPUT

  # (Deprecated) Legacy update-version job removed; handled by prepare-branch

  # ===========================================================================
  # Job 4: Create Pre-Release
  # ===========================================================================
  # Creates a GitHub pre-release with the RC tag
  # ===========================================================================
  
  create-prerelease:
    name: üè∑Ô∏è Create Pre-Release
    runs-on: ubuntu-latest
    needs: [validate-release, run-ci, prepare-branch]
    if: always() && needs.validate-release.outputs.is_rc == 'true' && needs.validate-release.outputs.deploy_to_qa == 'true'
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare-branch.outputs.release_branch }}
      
      - name: üìù Generate release notes
        id: release-notes
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          
          # Extract changes from CHANGELOG.md for this version
          echo "Extracting release notes for version $VERSION"
          
          # Create release notes
          cat > release_notes.md << EOF
          # AppsFlyer Flutter Plugin - Release Candidate $VERSION
          
          ## üöÄ Release Candidate for Testing
          
          This is a pre-release version for QA testing. Please do not use in production.
          
          ## üìã Changes
          
          Please refer to [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for detailed changes.
          
          ## üß™ Testing Instructions
          
          1. Add to your \`pubspec.yaml\`:
             \`\`\`yaml
             dependencies:
               appsflyer_sdk:
                 git:
                   url: https://github.com/${{ github.repository }}.git
                   ref: $VERSION
             \`\`\`
          
          2. Run \`flutter pub get\`
          3. Test the integration thoroughly
          4. Report any issues to the development team
          
          ## üì¶ SDK Versions
          
          - Android AppsFlyer SDK: (check android/build.gradle)
          - iOS AppsFlyer SDK: (check ios/appsflyer_sdk.podspec)
          
          ---
          
          **Note**: This is a pre-release and should not be used in production applications.
          EOF
          
          echo "Release notes generated"
      
      - name: üè∑Ô∏è Create GitHub Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-release.outputs.version }}
          name: Release Candidate ${{ needs.validate-release.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: true  # Mark as pre-release
          generate_release_notes: false
          token: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Job 5: Notify Team (Placeholder for Slack Integration)
  # ===========================================================================
  # Sends notification to Slack channel about the RC release
  # ===========================================================================
  
  open-pr:
    name: üîÄ Open PR to master
    runs-on: ubuntu-latest
    needs: [validate-release, prepare-branch]
    if: always() && needs.validate-release.outputs.deploy_to_qa == 'true'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare-branch.outputs.release_branch }}
      - name: üß† Create or update PR
        uses: actions/github-script@v7
        with:
          script: |
            const version = `${{ toJSON(needs.validate-release.outputs.base_version) }}`;
            const head = `${{ toJSON(needs.prepare-branch.outputs.release_branch) }}`;
            const base = 'master';
            // Find existing PR
            const { data: prs } = await github.rest.pulls.list({ owner: context.repo.owner, repo: context.repo.repo, state: 'open', head: `${context.repo.owner}:${head}` });
            const body = `### Release ${version}\n\n- Android SDK: ${{ needs.validate-release.outputs.android_sdk_version }}\n- iOS SDK: ${{ needs.validate-release.outputs.ios_sdk_version }}\n\nThis PR was opened by the RC workflow.`;
            if (prs.length > 0) {
              const pr = prs[0];
              await github.rest.pulls.update({ owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, title: `Release ${version}`, body });
              core.setOutput('pr_number', pr.number);
            } else {
              const { data: pr } = await github.rest.pulls.create({ owner: context.repo.owner, repo: context.repo.repo, head, base, title: `Release ${version}`, body, maintainer_can_modify: true });
              core.setOutput('pr_number', pr.number);
            }

  publish-rc:
    name: üì¶ Publish RC to pub.dev
    runs-on: ubuntu-latest
    needs: [validate-release, prepare-branch]
    if: always() && needs.validate-release.outputs.deploy_to_qa == 'true'
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare-branch.outputs.release_branch }}
      - name: üîß Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - name: üì¶ Get dependencies
        run: flutter pub get
      - name: üìù Validate package (dry-run)
        run: flutter pub publish --dry-run
      - name: ‚ÑπÔ∏è RC dry-run active ‚Äî skipping publish
        if: ${{ needs.validate-release.outputs.dry_run == 'true' }}
        run: |
          echo "RC dry_run is true ‚Äî will not publish to pub.dev."
      - name: üöÄ Publish RC to pub.dev
        if: ${{ needs.validate-release.outputs.dry_run != 'true' }}
        env:
          PUB_DEV_CREDENTIALS: ${{ secrets.PUB_DEV_CREDENTIALS }}
        run: |
          if [[ -z "${PUB_DEV_CREDENTIALS}" ]]; then
            echo "PUB_DEV_CREDENTIALS is missing"; exit 1; fi
          mkdir -p ~/.config/dart
          echo "${PUB_DEV_CREDENTIALS}" > ~/.config/dart/pub-credentials.json
          flutter pub publish --force
          rm -f ~/.config/dart/pub-credentials.json

  notify-team:
    name: üì¢ Notify Team
    runs-on: ubuntu-latest
    needs: [validate-release, create-prerelease]
    if: always()
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üìù Extract SDK versions and changelog
        id: extract-info
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          BASE_VERSION=$(echo "$VERSION" | sed 's/-rc[0-9]*$//')
          
          # Extract Android SDK version
          ANDROID_SDK_VERSION=$(grep "implementation 'com.appsflyer:af-android-sdk:" android/build.gradle | sed -n "s/.*af-android-sdk:\([^']*\).*/\1/p" | head -1)
          echo "android_sdk=$ANDROID_SDK_VERSION" >> $GITHUB_OUTPUT
          
          # Extract iOS SDK version
          IOS_SDK_VERSION=$(grep "s.ios.dependency 'AppsFlyerFramework'" ios/appsflyer_sdk.podspec | sed -n "s/.*AppsFlyerFramework',.*'\([^']*\)'.*/\1/p" | head -1)
          echo "ios_sdk=$IOS_SDK_VERSION" >> $GITHUB_OUTPUT
          
          # Extract Purchase Connector versions from build files
          ANDROID_PC_VERSION=$(grep "implementation 'com.appsflyer:purchase-connector:" android/build.gradle | sed -n "s/.*purchase-connector:\([^']*\).*/\1/p" | head -1)
          if [ -z "$ANDROID_PC_VERSION" ]; then
            ANDROID_PC_VERSION="N/A"
          fi
          echo "android_pc=$ANDROID_PC_VERSION" >> $GITHUB_OUTPUT
          
          IOS_PC_VERSION=$(grep "s.ios.dependency 'PurchaseConnector'" ios/appsflyer_sdk.podspec | sed -n "s/.*PurchaseConnector',.*'\([^']*\)'.*/\1/p" | head -1)
          if [ -z "$IOS_PC_VERSION" ]; then
            IOS_PC_VERSION="N/A"
          fi
          echo "ios_pc=$IOS_PC_VERSION" >> $GITHUB_OUTPUT
          
          # Extract changelog for this version (use base version without -rc suffix)
          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG=$(awk "/## $BASE_VERSION/,/^## [0-9]/" CHANGELOG.md | grep "^-" | sed 's/^- /‚Ä¢ /' | head -5)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="‚Ä¢ Check CHANGELOG.md for details"
            fi
          else
            CHANGELOG="‚Ä¢ Check release notes for details"
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: üé´ Fetch Jira tickets
        id: jira-tickets
        continue-on-error: true  # Don't fail CI if Jira fetch fails
        run: |
          set +e  # Don't exit on errors
          
          VERSION="${{ needs.validate-release.outputs.version }}"
          # Remove -rc suffix for Jira lookup (e.g., 99.99.99-rc1 ‚Üí 99.99.99)
          BASE_VERSION=$(echo "$VERSION" | sed 's/-rc[0-9]*$//')
          # Use base version with 'v' prefix (matches your Jira convention)
          JIRA_FIX_VERSION="Flutter SDK v$BASE_VERSION"
          
          echo "üîç Looking for Jira tickets with fix version: $JIRA_FIX_VERSION"
          
          # Check if Jira credentials are available
          if [[ -z "${{ secrets.CI_JIRA_EMAIL }}" ]] || [[ -z "${{ secrets.CI_JIRA_TOKEN }}" ]]; then
            echo "‚ö†Ô∏è Jira credentials not configured"
            echo "tickets=No assigned fix version found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          JIRA_DOMAIN="${{ secrets.CI_JIRA_DOMAIN || 'appsflyer.atlassian.net' }}"
          
          # URL-encode the JQL query properly
          JQL_QUERY="fixVersion=\"${JIRA_FIX_VERSION}\""
          # Use curl's --data-urlencode for proper encoding
          ENCODED_JQL=$(echo "$JQL_QUERY" | jq -sRr @uri)
          
          echo "üì° Querying Jira API..."
          echo "Domain: $JIRA_DOMAIN"
          echo "JQL: $JQL_QUERY"
          
          # Query Jira API with error handling and verbose output
          # Using the new /search/jql endpoint as per Jira API v3
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -u "${{ secrets.CI_JIRA_EMAIL }}:${{ secrets.CI_JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            "https://${JIRA_DOMAIN}/rest/api/3/search/jql?jql=${ENCODED_JQL}&fields=key,summary&maxResults=20")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "‚ö†Ô∏è Jira API request failed with status $HTTP_CODE"
            echo "Response body (first 500 chars):"
            echo "$BODY" | head -c 500
            echo "tickets=No assigned fix version found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extract ticket keys and create links with summaries
          TICKETS=$(echo "$BODY" | jq -r '.issues[]? | "‚Ä¢ https://'"${JIRA_DOMAIN}"'/browse/\(.key) - \(.fields.summary)"' 2>/dev/null | head -10)
          
          if [ -z "$TICKETS" ]; then
            echo "‚ÑπÔ∏è No linked tickets found for version: $JIRA_FIX_VERSION"
            echo "tickets=No assigned fix version found" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Found Jira tickets:"
            echo "$TICKETS"
            echo "tickets<<EOF" >> $GITHUB_OUTPUT
            echo "$TICKETS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: üì¢ Determine status
        id: status
        run: |
          STATUS="${{ needs.create-prerelease.result }}"
          
          if [[ "$STATUS" == "success" ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: üì® Send Slack notification (Success)
        if: steps.status.outputs.success == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "<!here>\n:flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter:\n\n*Flutter Release Candidate:*\nappsflyer_sdk: ${{ needs.validate-release.outputs.version }} is ready for QA testing.\n\n*Testing Instructions:*\nAdd to pubspec.yaml:\n```\ndependencies:\n  appsflyer_sdk:\n    git:\n      url: https://github.com/${{ github.repository }}.git\n      ref: ${{ needs.validate-release.outputs.version }}\n```\n\n*Sources:*\n:github: https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}\n:github: Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-release.outputs.version }}\n\n*Changes and fixes:*\n${{ steps.extract-info.outputs.changelog }}\n\n*Linked tickets and issues:*\n${{ steps.jira-tickets.outputs.tickets }}\n\n*Native SDK's:*\n:android: ${{ steps.extract-info.outputs.android_sdk }}\n:apple: ${{ steps.extract-info.outputs.ios_sdk }}\n\n*Purchase Connector:*\n:android: ${{ steps.extract-info.outputs.android_pc }}\n:apple: ${{ steps.extract-info.outputs.ios_pc }}\n\n:flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter::flutter:"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.CI_SLACK_WEBHOOK_URL }}
      
      - name: üì® Send failure notification
        if: steps.status.outputs.success == 'false'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "<!here>\n:warning: *Flutter RC Creation Failed*\n\nVersion: ${{ needs.validate-release.outputs.version }}\nBranch: ${{ github.ref_name }}\n\nPlease check the workflow logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.CI_SLACK_WEBHOOK_URL }}

  # ===========================================================================
  # Job 6: RC Summary
  # ===========================================================================
  # Provides a summary of the RC release process
  # ===========================================================================
  
  rc-summary:
    name: üìã RC Summary
    runs-on: ubuntu-latest
    needs: [validate-release, run-ci, prepare-branch, create-prerelease]
    if: always()
    
    steps:
      - name: üìä Display RC Summary
        run: |
          echo "========================================="
          echo "RC Release Summary"
          echo "========================================="
          echo "Version: ${{ needs.validate-release.outputs.version }}"
          echo "Is RC: ${{ needs.validate-release.outputs.is_rc }}"
          echo "Is Valid: ${{ needs.validate-release.outputs.is_valid }}"
          echo "-----------------------------------------"
          echo "Validation: ${{ needs.validate-release.result }}"
          echo "CI Pipeline: ${{ needs.run-ci.result }}"
          echo "Prepare Branch: ${{ needs.prepare-branch.result }}"
          echo "Pre-Release: ${{ needs.create-prerelease.result }}"
          echo "========================================="
          
          # Check if all critical jobs succeeded
          if [[ "${{ needs.validate-release.result }}" == "success" ]] && \
             [[ "${{ needs.create-prerelease.result }}" == "success" ]]; then
            echo "‚úÖ RC Release Process Completed Successfully"
            echo ""
            echo "Next Steps:"
            echo "1. Notify QA team to begin testing"
            echo "2. Test the RC version thoroughly"
            echo "3. If approved, proceed with production release"
          else
            echo "‚ùå RC Release Process Failed"
            echo "Please check the logs above for details"
            exit 1
          fi
